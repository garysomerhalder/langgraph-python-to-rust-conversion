# HIL-003: State inspection during execution

## 📋 Task Overview
**ID:** HIL-003
**Title:** State inspection during execution
**Status:** 💀 BROKEN (marked done, but incomplete)
**Priority:** P0 (Critical)
**Category:** Human-in-the-Loop
**Estimated Days:** 2 (needs complete implementation)
**Phase:** Phase 1 - Critical Features

## 🚨 CRITICAL ISSUE
**MARKED AS DONE IN COMMITS BUT IMPLEMENTATION IS INCOMPLETE**
- StateInspector has stub methods
- Tests don't compile with HIL suite
- Missing critical inspection functionality

## 🎯 Objective
Implement a state inspection system that allows developers to examine and query the current state at any point during graph execution, particularly at breakpoints and interrupts.

## 📝 Description
State inspection is crucial for debugging and understanding execution flow. Developers need to:
- View the complete state at any execution point
- Query specific state values
- Track state changes over time
- Inspect state history and transitions
- Export state snapshots for analysis

## ✅ Acceptance Criteria
- [ ] Can inspect full state at breakpoints
- [ ] Can query specific state keys/paths
- [ ] Can view state history and transitions
- [ ] Can export state snapshots
- [ ] Can diff states between execution points
- [ ] Can filter/search state contents
- [ ] Thread-safe state access during inspection
- [ ] Integration with breakpoint system
- [ ] Integration with interrupt system
- [ ] Performance: minimal overhead when not inspecting

## 🔧 Technical Requirements

### Core Components to Implement
```rust
// src/engine/state_inspector.rs
pub struct StateInspector {
    /// History of state snapshots
    history: Arc<RwLock<Vec<StateSnapshot>>>,

    /// Active inspection sessions
    sessions: DashMap<String, InspectionSession>,

    /// State change listeners
    listeners: Arc<RwLock<Vec<StateChangeListener>>>,
}

pub struct StateSnapshot {
    pub id: Uuid,
    pub timestamp: SystemTime,
    pub node_id: String,
    pub state: StateData,
    pub metadata: HashMap<String, Value>,
}

pub struct InspectionSession {
    pub id: String,
    pub started_at: SystemTime,
    pub filters: Vec<StateFilter>,
    pub watch_list: Vec<String>,
}

impl StateInspector {
    pub async fn capture_snapshot(&self, node_id: &str, state: &StateData) -> Uuid;
    pub async fn get_snapshot(&self, id: Uuid) -> Option<StateSnapshot>;
    pub async fn query_state(&self, snapshot_id: Uuid, path: &str) -> Option<Value>;
    pub async fn diff_states(&self, id1: Uuid, id2: Uuid) -> StateDiff;
    pub async fn export_snapshot(&self, id: Uuid, format: ExportFormat) -> String;
    pub async fn search_state(&self, pattern: &str) -> Vec<(String, Value)>;
}
```

### Integration Points
1. **ExecutionEngine** - Capture state at each node
2. **BreakpointManager** - Auto-inspect at breakpoints
3. **InterruptManager** - Provide state for approval decisions
4. **GraphState** - Hook into state updates

## 🚦 Implementation Plan

### 🔴 RED Phase - Tests First
- Write tests for state capture and retrieval
- Test query and filtering operations
- Test state diff functionality
- Test export formats (JSON, YAML, etc.)

### 🟡 YELLOW Phase - Minimal Implementation
- Basic StateInspector structure
- Simple snapshot capture and storage
- Basic query by key
- Integration with ExecutionEngine

### 🟢 GREEN Phase - Production Ready
- Full query language support
- Advanced filtering and search
- State diff visualization
- Performance optimizations
- Export to multiple formats
- Real-time state watching

## 📊 Success Metrics
- Zero performance impact when inspection disabled
- < 10ms snapshot capture time
- < 1ms state query response time
- Thread-safe concurrent inspections
- All state changes captured

## 🔗 Dependencies
- HIL-001 (Interrupt mechanism) - DONE
- HIL-002 (Breakpoint system) - DONE
- ExecutionEngine
- GraphState

## 🎯 Definition of Done
- [ ] All acceptance criteria met
- [ ] Tests passing (RED → YELLOW → GREEN)
- [ ] Code reviewed and approved
- [ ] Documentation updated
- [ ] Example added showing state inspection
- [ ] Performance benchmarked